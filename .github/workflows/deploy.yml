---
name: Deploy to backup.eshopion.sk

"on":
  push:
    tags: ['v*']
  workflow_dispatch: {}

jobs:
  deploy:
    name: Deploy to remote server via SSH
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Setup SSH key (inline)
        run: |
          mkdir -p ~/.ssh
          umask 077
          echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}

      - name: Ensure remote host known
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.DEPLOY_PORT }}" \
            "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Debug SSH connection (verbose, no transfer)
        run: |
          echo "--- SSH debug: attempting non-interactive connection ---"
          ssh -o BatchMode=yes -p "${{ secrets.DEPLOY_PORT }}" \
            "${{ secrets.DEPLOY_USER }}"@"${{ secrets.DEPLOY_HOST }}" \
            -vvv 'echo connected && whoami && uname -a' || \
            (echo "SSH debug failed"; exit 1)

      - name: Rsync files to server
        run: |
          RSYNC_EXCLUDE='--exclude .git --exclude tests --exclude .github'
          USER_HOST="${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}"
          DEST="${USER_HOST}:${{ secrets.DEPLOY_PATH }}"
          rsync -avz -e "ssh -p ${{ secrets.DEPLOY_PORT }}" \
            $RSYNC_EXCLUDE ./ \
            "$DEST"

      - name: Run remote post-deploy tasks
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            # ensure permissions
            # some hosts don't have a same-named group; change to set owner only
            DEPLOY_PATH_VAR="${{ secrets.DEPLOY_PATH }}"
            chown -R "${{ secrets.DEPLOY_USER }}" \
              "$DEPLOY_PATH_VAR"
            find "$DEPLOY_PATH_VAR" -type d -print0 | xargs -0 chmod 755
            find "$DEPLOY_PATH_VAR" -type f -print0 | xargs -0 chmod 644
            # optional: create simple index listing (if no web index exists)
            if [ ! -f "${{ secrets.DEPLOY_PATH }}/index.html" ]; then
              printf '%s\n' '<html>' > /tmp/listing.html
              printf '%s\n' '<body>' >> /tmp/listing.html
              printf '%s\n' '<h1>Backups</h1>' >> /tmp/listing.html
              printf '%s\n' '<pre>' >> /tmp/listing.html
              ls -la "$DEPLOY_PATH_VAR" >> /tmp/listing.html
              printf '%s\n' '</pre>' >> /tmp/listing.html
              printf '%s\n' '</body>' >> /tmp/listing.html
              printf '%s\n' '</html>' >> /tmp/listing.html
              mv /tmp/listing.html "$DEPLOY_PATH_VAR/index.html"
              chmod 644 "$DEPLOY_PATH_VAR/index.html"
            fi
